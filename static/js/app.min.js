let modelSelect,chatDisplay,initialWidth,initialX,chatHistory=[],lastTokenSequence=null,lastResponseTokens=[],lastResponseProbs=[],selectedPosition=null,isResizing=!1,socket=null,currentMessageDiv=null;function setupSettingsToggle(groupName){const toggle=document.getElementById(`toggle-${groupName}`),group=document.getElementById(`${groupName}-group`);toggle.addEventListener("change",(()=>{if(group.classList.toggle("disabled",!toggle.checked),!toggle.checked){group.querySelectorAll('input[type="number"]').forEach((input=>{switch(input.id){case"temperature-value":case"top-p-value":case"repetition-penalty-value":input.value="1.0";break;case"min-p-value":case"top-k-value":input.value="0";break;case"frequency-penalty-value":input.value="0.0";break;case"dry-allowed-length":input.value="1";break;case"dry-base":input.value="2";break;case"dry-multiplier":input.value="3";break;case"dry-range":input.value="1024"}}))}}))}function getSettings(){const selectedModel=modelSelect.value,randomnessEnabled=document.getElementById("toggle-randomness").checked,penaltiesEnabled=document.getElementById("toggle-penalties").checked,dryEnabled=document.getElementById("toggle-dry").checked;let temperature=1,min_p=0,top_k=0,top_p=1,repetition_penalty=1,frequency_penalty=0,repeat_last_n=64,dry_allowed_length=2,dry_base=1.2,dry_multiplier=2,dry_range=512;randomnessEnabled&&(temperature=parseFloat(document.getElementById("temperature-value").value)||.7,min_p=parseFloat(document.getElementById("min-p-value").value)||0,top_k=parseInt(document.getElementById("top-k-value").value)||0,top_p=parseFloat(document.getElementById("top-p-value").value)||1),penaltiesEnabled&&(repetition_penalty=parseFloat(document.getElementById("repetition-penalty-value").value)||1,frequency_penalty=parseFloat(document.getElementById("frequency-penalty-value").value)||0,repeat_last_n=parseInt(document.getElementById("repeat-last-n-value").value)||64),dryEnabled&&(dry_allowed_length=parseInt(document.getElementById("dry-allowed-length").value)||1,dry_base=parseFloat(document.getElementById("dry-base").value)||2,dry_multiplier=parseFloat(document.getElementById("dry-multiplier").value)||3,dry_range=parseInt(document.getElementById("dry-range").value)||1024);return{model_name:selectedModel,randomness_enabled:randomnessEnabled,penalties_enabled:penaltiesEnabled,dry_enabled:dryEnabled,num_show:parseInt(document.getElementById("num-show-value").value)||12,temperature:temperature,min_p:min_p,top_k:top_k,max_new_tokens:parseInt(document.getElementById("max-new-tokens-value").value)||0,top_p:top_p,repetition_penalty:repetition_penalty,frequency_penalty:frequency_penalty,repeat_last_n:repeat_last_n,dry_allowed_length:dry_allowed_length,dry_base:dry_base,dry_multiplier:dry_multiplier,dry_range:dry_range}}async function generateResponse(chat_history){socket.emit("stop"),socket.emit("generate",{chat_history:chat_history,...getSettings()})}async function generateText(){const prompt=document.getElementById("prompt").value;document.getElementById("prompt").value="",prompt.trim()&&(chatHistory.push({role:"user",content:prompt}),messageDiv=document.createElement("div"),chatHistory.push({role:"assistant",content:"",partial:!0,tokenSequence:[],id:chatHistory.length,chosenTokens:[]}),updateChatDisplay(),await generateResponse(chatHistory))}function updateChatDisplay(){chatDisplay.innerHTML="",chatHistory.forEach(((message,messageIndex)=>{const messageDiv=document.createElement("div");messageDiv.className=`message ${message.role}`,"assistant"===message.role&&Array.isArray(message.tokenSequence)?message.tokenSequence.forEach(((alternatives,position)=>{if(!Array.isArray(alternatives)||0===alternatives.length)return;const chosenToken=alternatives.find((([_,__,isChosen])=>isChosen));if(!chosenToken)return;const[token,prob,_]=chosenToken,probColor=getProbabilityColor(prob);let i=0;token.split("\n").map((token=>{if(i>0){const br=document.createElement("br");messageDiv.appendChild(br)}const tokenSpan=document.createElement("span");tokenSpan.textContent=token,tokenSpan.className="token",tokenSpan.dataset.position=position,tokenSpan.dataset.messageIndex=messageIndex,tokenSpan.onclick=()=>showTokenOptions(message,position),tokenSpan.style.backgroundColor=probColor,messageDiv.appendChild(tokenSpan),i++}))})):messageDiv.textContent=message.content,chatDisplay.appendChild(messageDiv)})),chatDisplay.scrollTop=chatDisplay.scrollHeight}function getProbabilityColor(prob){return`rgba(${255-Math.floor(255*prob)}, ${Math.floor(255*prob)}, 0, 0.5)`}function showTokenOptions(message,position){const alternatives=message.tokenSequence[position];if(!alternatives)return;const modal=document.getElementById("token-modal"),modalContent=document.getElementById("token-options");modalContent.innerHTML="",alternatives.sort(((a,b)=>b[1]-a[1])).forEach((([token,prob,isChosen])=>{const optionDiv=document.createElement("div");optionDiv.className="token-option "+(isChosen?"chosen":"");const tokenSpan=document.createElement("span");tokenSpan.className="token-text",tokenSpan.textContent=token;const probSpan=document.createElement("span");probSpan.className="token-prob",probSpan.textContent=(100*prob).toFixed(2)+"%";const probColor=getProbabilityColor(prob);optionDiv.style.borderLeft=`4px solid ${probColor}`,optionDiv.appendChild(tokenSpan),optionDiv.appendChild(probSpan),optionDiv.onclick=()=>{replaceToken(message,position,token),closeTokenModal()},modalContent.appendChild(optionDiv)})),modal.style.display="block"}function closeTokenModal(){document.getElementById("token-modal").style.display="none"}async function replaceToken(message,position,token){chatHistory=chatHistory.slice(0,message.id+1),message.partial=!0,message.chosenTokens=message.chosenTokens.slice(0,position).concat([message.tokenSequence[position].find((([t,_,__])=>t===token))[0]]),message.content=message.chosenTokens.join(""),message.tokenSequence=message.tokenSequence.slice(0,position).concat([message.tokenSequence[position].map((([t,p,c])=>[t,p,t===token]))]),await generateResponse(chatHistory)}function handleMouseMove(e){if(!isResizing)return;const settingsContainer=document.querySelector(".settings-container"),delta=initialX-e.clientX,newWidth=Math.max(300,Math.min(600,initialWidth+delta));settingsContainer.style.width=`${newWidth}px`}function initializeWebSocket(){socket=io(),socket.on("connect",(()=>{console.log("Connected to WebSocket server")})),socket.on("disconnect",(()=>{console.log("Disconnected from WebSocket server")})),socket.on("error",(data=>{console.error("Server error:",data.message),alert(`Error generating response: ${data.message}`)})),socket.on("token",(data=>{console.log("Received token:",data),currentMessageDiv||(currentMessageDiv=document.createElement("div"),currentMessageDiv.className="message assistant",chatDisplay.appendChild(currentMessageDiv));const{chosen:chosen,options:options,message_id:message_id,token_id:token_id}=data;options&&options.length>0&&(chatHistory[chatHistory.length-1].partial?(chatHistory[chatHistory.length-1].content+=chosen,chatHistory[chatHistory.length-1].chosenTokens.push(chosen),chatHistory[chatHistory.length-1].tokenSequence.push(options)):chatHistory.push({role:"assistant",content:chosen,partial:!0,tokenSequence:[options],id:chatHistory.length,chosenTokens:[chosen]}),updateChatDisplay())})),socket.on("end",(()=>{chatHistory[chatHistory.length-1].partial&&(chatHistory[chatHistory.length-1].partial=!1),console.log("end"),updateChatDisplay()}))}document.addEventListener("DOMContentLoaded",(()=>{initializeWebSocket(),document.getElementById("send-button").addEventListener("click",generateText),modelSelect=document.getElementById("model-select"),chatDisplay=document.getElementById("chat-display"),document.getElementById("prompt").addEventListener("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),generateText())})),window.addEventListener("click",(e=>{const modal=document.getElementById("token-modal");e.target===modal&&closeTokenModal()}));const settingsContainer=document.querySelector(".settings-container"),toggleButton=document.getElementById("toggle-settings"),dragHandle=document.querySelector(".drag-handle");toggleButton.addEventListener("click",(()=>{settingsContainer.classList.toggle("closed"),settingsContainer.classList.contains("closed")?settingsContainer.style.width="0":settingsContainer.style.width="300px"})),dragHandle.addEventListener("mousedown",(e=>{isResizing=!0,initialWidth=settingsContainer.offsetWidth,initialX=e.clientX,document.addEventListener("mousemove",handleMouseMove),document.addEventListener("mouseup",(()=>{isResizing=!1,document.removeEventListener("mousemove",handleMouseMove)}))})),window.innerWidth<=768&&toggleButton.addEventListener("click",(()=>{settingsContainer.classList.toggle("open")})),setupSettingsToggle("randomness"),setupSettingsToggle("penalties"),setupSettingsToggle("dry")}));